<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gostcrypt: Driver/Ntvol.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Gostcrypt
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_7151b3cc910409bb744bd274374c738d.html">Driver</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">Ntvol.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>contains functions that open a volume / close a volume, and update the accessed time.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;Gstdefs.h&quot;</code><br />
<code>#include &lt;wchar.h&gt;</code><br />
<code>#include &quot;Crypto.h&quot;</code><br />
<code>#include &quot;Volumes.h&quot;</code><br />
<code>#include &quot;Apidrvr.h&quot;</code><br />
<code>#include &quot;DriveFilter.h&quot;</code><br />
<code>#include &quot;Ntdriver.h&quot;</code><br />
<code>#include &quot;Ntvol.h&quot;</code><br />
<code>#include &quot;VolumeFilter.h&quot;</code><br />
<code>#include &quot;Boot/Windows/BootCommon.h&quot;</code><br />
<code>#include &quot;Cache.h&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for Ntvol.c:</div>
<div class="dyncontent">
<div class="center"><img src="_ntvol_8c__incl.png" border="0" usemap="#_driver_2_ntvol_8c" alt=""/></div>
<map name="_driver_2_ntvol_8c" id="_driver_2_ntvol_8c">
<area shape="rect" id="node2" href="_gstdefs_8h_source.html" title="Gstdefs.h" alt="" coords="718,528,797,555"/>
<area shape="rect" id="node6" href="_crypto_8h_source.html" title="Crypto.h" alt="" coords="605,379,675,405"/>
<area shape="rect" id="node14" href="_volumes_8h_source.html" title="Volumes.h" alt="" coords="1217,304,1301,331"/>
<area shape="rect" id="node15" href="_apidrvr_8h_source.html" title="Apidrvr.h" alt="" coords="809,229,881,256"/>
<area shape="rect" id="node19" href="_drive_filter_8h_source.html" title="DriveFilter.h" alt="" coords="944,80,1035,107"/>
<area shape="rect" id="node20" href="_boot_common_8h_source.html" title="Boot/Windows/BootCommon.h" alt="" coords="1081,229,1281,256"/>
<area shape="rect" id="node22" href="_ntdriver_8h_source.html" title="Ntdriver.h" alt="" coords="725,80,801,107"/>
<area shape="rect" id="node23" href="_ntvol_8h_source.html" title="Ntvol.h" alt="" coords="1447,80,1508,107"/>
<area shape="rect" id="node24" href="_volume_filter_8h_source.html" title="VolumeFilter.h" alt="" coords="257,155,364,181"/>
<area shape="rect" id="node25" href="_cache_8h_source.html" title="Cache.h" alt="" coords="654,155,725,181"/>
<area shape="rect" id="node7" href="_gost_cipher_8h_source.html" title="GostCipher.h" alt="" coords="205,453,304,480"/>
<area shape="rect" id="node8" href="_grasshopper_cipher_8h_source.html" title="GrasshopperCipher.h" alt="" coords="328,453,472,480"/>
<area shape="rect" id="node9" href="_stribog_8h_source.html" title="Stribog.h" alt="" coords="496,453,571,480"/>
<area shape="rect" id="node10" href="_whirlpool_8h_source.html" title="Whirlpool.h" alt="" coords="94,453,181,480"/>
<area shape="rect" id="node11" href="_gost_hash_8h_source.html" title="GostHash.h" alt="" coords="595,453,685,480"/>
<area shape="rect" id="node12" href="_gf_mul_8h_source.html" title="GfMul.h" alt="" coords="760,453,827,480"/>
<area shape="rect" id="node13" href="_password_8h_source.html" title="Password.h" alt="" coords="1216,453,1307,480"/>
<area shape="rect" id="node16" href="_boot_defs_8h_source.html" title="Boot/Windows/BootDefs.h" alt="" coords="966,304,1141,331"/>
<area shape="rect" id="node17" href="_common_8h_source.html" title="Common.h" alt="" coords="653,304,739,331"/>
<area shape="rect" id="node18" href="_wipe_8h_source.html" title="Wipe.h" alt="" coords="865,379,927,405"/>
<area shape="rect" id="node21" href="_encrypted_io_queue_8h_source.html" title="EncryptedIoQueue.h" alt="" coords="866,155,1006,181"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a5417ad2f111b636fbd8093be9f4f7fca"><td class="memItemLeft" align="right" valign="top">NTSTATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ntvol_8c.html#a5417ad2f111b636fbd8093be9f4f7fca">GSTOpenVolume</a> (PDEVICE_OBJECT DeviceObject, <a class="el" href="struct_e_x_t_e_n_s_i_o_n.html">PEXTENSION</a> Extension, MOUNT_STRUCT *mount, PWSTR pwszMountVolume, BOOL bRawDevice)</td></tr>
<tr class="memdesc:a5417ad2f111b636fbd8093be9f4f7fca"><td class="mdescLeft">&#160;</td><td class="mdescRight">Query the size of the device to open. Open the device and return error messages. Then check the file format we want to open (NTFS / FAT ...) then check volume size and type (hidden ...) and read the header. Attempt to decrypt the header. Decrypt the sectors. Protect the hidden volume (don't decrypt them).  <a href="#a5417ad2f111b636fbd8093be9f4f7fca">More...</a><br /></td></tr>
<tr class="separator:a5417ad2f111b636fbd8093be9f4f7fca"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3e05d294f15f24148106049b4cab1237"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ntvol_8c.html#a3e05d294f15f24148106049b4cab1237">GSTCloseVolume</a> (PDEVICE_OBJECT DeviceObject, <a class="el" href="struct_e_x_t_e_n_s_i_o_n.html">PEXTENSION</a> Extension)</td></tr>
<tr class="memdesc:a3e05d294f15f24148106049b4cab1237"><td class="mdescLeft">&#160;</td><td class="mdescRight">Close the volume decrypted thanks to the previous function.  <a href="#a3e05d294f15f24148106049b4cab1237">More...</a><br /></td></tr>
<tr class="separator:a3e05d294f15f24148106049b4cab1237"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a48aec4d8c18a1774e6662108d9a0cfb5"><td class="memItemLeft" align="right" valign="top">NTSTATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ntvol_8c.html#a48aec4d8c18a1774e6662108d9a0cfb5">GSTSendHostDeviceIoControlRequest</a> (PDEVICE_OBJECT DeviceObject, <a class="el" href="struct_e_x_t_e_n_s_i_o_n.html">PEXTENSION</a> Extension, ULONG IoControlCode, void *OutputBuffer, ULONG OutputBufferSize)</td></tr>
<tr class="memdesc:a48aec4d8c18a1774e6662108d9a0cfb5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Call the driver with an irp to return the block status.  <a href="#a48aec4d8c18a1774e6662108d9a0cfb5">More...</a><br /></td></tr>
<tr class="separator:a48aec4d8c18a1774e6662108d9a0cfb5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a65a14c883adcc3846c8b707bebf3537b"><td class="memItemLeft" align="right" valign="top">NTSTATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ntvol_8c.html#a65a14c883adcc3846c8b707bebf3537b">COMPLETE_IRP</a> (PDEVICE_OBJECT DeviceObject, PIRP Irp, NTSTATUS IrpStatus, ULONG_PTR IrpInformation)</td></tr>
<tr class="memdesc:a65a14c883adcc3846c8b707bebf3537b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Complete the IRP with data (extra info provide the adresses completed)  <a href="#a65a14c883adcc3846c8b707bebf3537b">More...</a><br /></td></tr>
<tr class="separator:a65a14c883adcc3846c8b707bebf3537b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ad638c62db1e7059c1cdbbc4173dcac67"><td class="memItemLeft" align="right" valign="top">volatile BOOL&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ntvol_8c.html#ad638c62db1e7059c1cdbbc4173dcac67">ProbingHostDeviceForWrite</a> = FALSE</td></tr>
<tr class="separator:ad638c62db1e7059c1cdbbc4173dcac67"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>contains functions that open a volume / close a volume, and update the accessed time. </p>
<dl class="section version"><dt>Version</dt><dd>1.3.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>13/12/2016 </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a65a14c883adcc3846c8b707bebf3537b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a65a14c883adcc3846c8b707bebf3537b">&#9670;&nbsp;</a></span>COMPLETE_IRP()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void COMPLETE_IRP </td>
          <td>(</td>
          <td class="paramtype">PDEVICE_OBJECT&#160;</td>
          <td class="paramname"><em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PIRP&#160;</td>
          <td class="paramname"><em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">NTSTATUS&#160;</td>
          <td class="paramname"><em>IrpStatus</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ULONG_PTR&#160;</td>
          <td class="paramname"><em>IrpInformation</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Complete the IRP with data (extra info provide the adresses completed) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">PDEVICE_OBJECT</td><td>DeviceObject </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">PIRP</td><td>Irp </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">NTSTATUS</td><td>IrpStatus </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ULONG_PTR</td><td>IrpInformation </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>NTSTATUS IrpStatus </dd></dl>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="_ntvol_8c_a65a14c883adcc3846c8b707bebf3537b_icgraph.png" border="0" usemap="#_ntvol_8c_a65a14c883adcc3846c8b707bebf3537b_icgraph" alt=""/></div>
<map name="_ntvol_8c_a65a14c883adcc3846c8b707bebf3537b_icgraph" id="_ntvol_8c_a65a14c883adcc3846c8b707bebf3537b_icgraph">
<area shape="rect" id="node2" href="_ntdriver_8c.html#aa2ad3d74581504a31273a0903d590a4f" title="GSTDispatchQueueIRP queues any IRP&#39;s so that they can be processed later by the thread – or in some ..." alt="" coords="175,5,333,32"/>
</map>
</div>

</div>
</div>
<a id="a3e05d294f15f24148106049b4cab1237"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3e05d294f15f24148106049b4cab1237">&#9670;&nbsp;</a></span>GSTCloseVolume()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void GSTCloseVolume </td>
          <td>(</td>
          <td class="paramtype">PDEVICE_OBJECT&#160;</td>
          <td class="paramname"><em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="struct_e_x_t_e_n_s_i_o_n.html">PEXTENSION</a>&#160;</td>
          <td class="paramname"><em>Extension</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Close the volume decrypted thanks to the previous function. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">PEXTENSION</td><td>Extension </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">PDEVICE_OBJECT</td><td>DeviceObject </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>

</div>
</div>
<a id="a5417ad2f111b636fbd8093be9f4f7fca"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5417ad2f111b636fbd8093be9f4f7fca">&#9670;&nbsp;</a></span>GSTOpenVolume()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GSTOpenVolume </td>
          <td>(</td>
          <td class="paramtype">PDEVICE_OBJECT&#160;</td>
          <td class="paramname"><em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="struct_e_x_t_e_n_s_i_o_n.html">PEXTENSION</a>&#160;</td>
          <td class="paramname"><em>Extension</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MOUNT_STRUCT *&#160;</td>
          <td class="paramname"><em>mount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PWSTR&#160;</td>
          <td class="paramname"><em>pwszMountVolume</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">BOOL&#160;</td>
          <td class="paramname"><em>bRawDevice</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Query the size of the device to open. Open the device and return error messages. Then check the file format we want to open (NTFS / FAT ...) then check volume size and type (hidden ...) and read the header. Attempt to decrypt the header. Decrypt the sectors. Protect the hidden volume (don't decrypt them). </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">BOOL</td><td>bRawDevice </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">PWSTR</td><td>pwszMountVolume </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">MOUNT_STRUCT</td><td>* mount </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">PEXTENSION</td><td>Extension </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">PDEVICE_OBJECT</td><td>DeviceObject </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>NTSTATUS STATUS_SUCCESS status else </dd></dl>

</div>
</div>
<a id="a48aec4d8c18a1774e6662108d9a0cfb5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a48aec4d8c18a1774e6662108d9a0cfb5">&#9670;&nbsp;</a></span>GSTSendHostDeviceIoControlRequest()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void GSTSendHostDeviceIoControlRequest </td>
          <td>(</td>
          <td class="paramtype">PDEVICE_OBJECT&#160;</td>
          <td class="paramname"><em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="struct_e_x_t_e_n_s_i_o_n.html">PEXTENSION</a>&#160;</td>
          <td class="paramname"><em>Extension</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ULONG&#160;</td>
          <td class="paramname"><em>IoControlCode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>OutputBuffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ULONG&#160;</td>
          <td class="paramname"><em>OutputBufferSize</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Call the driver with an irp to return the block status. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">PDEVICE_OBJECT</td><td>DeviceObject </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">PEXTENSION</td><td>Extension </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ULONG</td><td>IoControlCode </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">void</td><td>* OutputBuffer </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ULONG</td><td>OutputBufferSize </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>NTSTATUS ntStatus </dd></dl>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ad638c62db1e7059c1cdbbc4173dcac67"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad638c62db1e7059c1cdbbc4173dcac67">&#9670;&nbsp;</a></span>ProbingHostDeviceForWrite</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile BOOL ProbingHostDeviceForWrite = FALSE</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Legal Notice: Some portions of the source code contained in this file were derived from the source code of Encryption for the Masses 2.02a, which is Copyright (c) 1998-2000 Paul Le Roux and which is governed by the 'License Agreement for Encryption for the Masses'. Modifications and additions to the original source code (contained in this file) and all other portions of this file are Copyright (c) 2003-2010 TrueCrypt Developers Association and are governed by the TrueCrypt License 3.0 the full text of which is contained in the file License.txt included in TrueCrypt binary and source code distribution packages. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
